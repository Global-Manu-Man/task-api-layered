# docker-compose.yml
# Stack completo: Task API + Prometheus + Grafana
# Configurado para HTTPS con Traefik (Coolify)

services:
  # ========================================
  # TASK API - Spring Boot Application
  # ========================================
  task-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: task-api
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - JAVA_OPTS=-Xmx512m -Xms256m
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      # HTTPS para Task API
      - "traefik.http.routers.task-api.rule=Host(`${TASK_API_DOMAIN}`)"
      - "traefik.http.routers.task-api.entrypoints=https"
      - "traefik.http.routers.task-api.tls=true"
      - "traefik.http.routers.task-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.task-api.loadbalancer.server.port=8080"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.task-api-http.rule=Host(`${TASK_API_DOMAIN}`)"
      - "traefik.http.routers.task-api-http.entrypoints=http"
      - "traefik.http.routers.task-api-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    networks:
      - task-network
      - coolify

  # ========================================
  # PROMETHEUS - Metrics Collector
  # ========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    expose:
      - "9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    depends_on:
      task-api:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # HTTPS para Prometheus
      - "traefik.http.routers.prometheus.rule=Host(`${PROMETHEUS_DOMAIN}`)"
      - "traefik.http.routers.prometheus.entrypoints=https"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.routers.prometheus.tls.certresolver=letsencrypt"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
      # Basic Auth para Prometheus (seguridad)
      - "traefik.http.routers.prometheus.middlewares=prometheus-auth"
      - "traefik.http.middlewares.prometheus-auth.basicauth.users=${PROMETHEUS_AUTH}"
    networks:
      - task-network
      - coolify

  # ========================================
  # GRAFANA - Visualization
  # ========================================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://${GRAFANA_DOMAIN}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    labels:
      - "traefik.enable=true"
      # HTTPS para Grafana
      - "traefik.http.routers.grafana.rule=Host(`${GRAFANA_DOMAIN}`)"
      - "traefik.http.routers.grafana.entrypoints=https"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
    networks:
      - task-network
      - coolify

volumes:
  prometheus_data:
  grafana_data:

networks:
  task-network:
    driver: bridge
  coolify:
    external: true