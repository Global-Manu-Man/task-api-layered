# azure-pipelines.yml
# Pipeline CI/CD para Task API - Spring Boot
# Usando Self-Hosted Agent

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

# === USA TU AGENTE LOCAL ===
pool:
  name: 'my-agent'

variables:
  JAVA_VERSION: '17'
  azureServiceConnection: 'azure-task-api'
  appServiceName: 'task-api-emmanuel'

stages:
  # ========================================
  # STAGE 1: BUILD & TEST
  # ========================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildJob
        displayName: 'Compilar y Probar'
        steps:
          # Paso 1: Checkout del codigo
          - checkout: self
            displayName: 'Checkout codigo'

          # Paso 2: Configurar Java 17
          - task: JavaToolInstaller@0
            displayName: 'Instalar Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Paso 3: Compilar con Maven
          - task: Maven@4
            displayName: 'Maven Build'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '-DskipTests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'

          # Paso 4: Copiar archivos para deploy
          - task: CopyFiles@2
            displayName: 'Copiar JAR'
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)/target'
              Contents: '*.jar'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          # Paso 5: Publicar artefacto
          - task: PublishBuildArtifacts@1
            displayName: 'Publicar Artefacto'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  # ========================================
  # STAGE 2: DEPLOY TO AZURE
  # ========================================
  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToAzure
        displayName: 'Deploy a Azure App Service'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                # Descargar artefacto
                - download: current
                  artifact: drop
                  displayName: 'Descargar artefacto'

                # Deploy a Azure App Service
                - task: AzureWebApp@1
                  displayName: 'Deploy a App Service'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(appServiceName)'
                    package: '$(Pipeline.Workspace)/drop/*.jar'
                    runtimeStack: 'JAVA|17-java17'