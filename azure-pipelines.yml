# azure-pipelines.yml
# Pipeline CI/CD para Task API - Spring Boot

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  JAVA_VERSION: '17'
  # === CONFIGURACION DE AZURE ===
  azureServiceConnection: 'azure-task-api'
  appServiceName: 'task-api-emmanuel'

stages:
  # ========================================
  # STAGE 1: BUILD & TEST
  # ========================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildJob
        displayName: 'Compilar y Probar'
        steps:
          # Paso 1: Checkout del codigo
          - checkout: self
            displayName: 'Checkout codigo'

          # Paso 2: Configurar Java 17
          - task: JavaToolInstaller@0
            displayName: 'Instalar Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Paso 3: Cache de Maven (acelera builds)
          - task: Cache@2
            displayName: 'Cache Maven'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: $(MAVEN_CACHE_FOLDER)

          # Paso 4: Compilar con Maven
          - task: Maven@4
            displayName: 'Maven Build'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '-DskipTests=false $(MAVEN_OPTS)'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'

          # Paso 5: Publicar artefacto JAR
          - task: PublishBuildArtifacts@1
            displayName: 'Publicar Artefacto'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'task-api-jar'
              publishLocation: 'Container'

          # Paso 6: Copiar archivos para deploy
          - task: CopyFiles@2
            displayName: 'Copiar archivos de deploy'
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)'
              Contents: |
                target/*.jar
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publicar para Deploy'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  # ========================================
  # STAGE 2: DEPLOY TO AZURE
  # ========================================
  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToAzure
        displayName: 'Deploy a Azure App Service'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                # Descargar artefacto
                - download: current
                  artifact: drop
                  displayName: 'Descargar artefacto'

                # Deploy a Azure App Service
                - task: AzureWebApp@1
                  displayName: 'Deploy a App Service'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(appServiceName)'
                    package: '$(Pipeline.Workspace)/drop/target/*.jar'
                    runtimeStack: 'JAVA|17-java17'